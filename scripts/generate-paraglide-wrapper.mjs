import fs from "node:fs";
import path from "node:path";

const frontendRoot = process.cwd();
const settingsPath = path.join(frontendRoot, "project.inlang", "settings.json");

const settings = JSON.parse(fs.readFileSync(settingsPath, "utf-8"));
const baseLocale = settings.baseLocale;

const localeDir = path.join(frontendRoot, "messages", baseLocale);
const files = fs.readdirSync(localeDir).filter((file) => file.endsWith(".json")).sort();

const keys = [];
const seen = new Set();

for (const file of files) {
  const data = JSON.parse(fs.readFileSync(path.join(localeDir, file), "utf-8"));
  for (const key of Object.keys(data)) {
    if (key === "$schema") continue;
    if (seen.has(key)) continue;
    seen.add(key);
    keys.push(key);
  }
}

const header = `/* eslint-disable */\n// This file is generated by scripts/generate-paraglide-wrapper.mjs.\n// Do not edit manually.\n\nimport { baseLocale, getLocale, isLocale } from "./runtime.js";\n\nconst localeLoaders = import.meta.glob("../paraglide-generated/messages/*.js");\nconst localeCache = new Map();\n\nconst cacheModule = (locale, module) => {\n  localeCache.set(locale, module);\n  return module;\n};\n\nimport * as baseMessages from "../paraglide-generated/messages/${baseLocale}.js";\ncacheModule(baseLocale, baseMessages);\n\nexport async function preloadLocaleMessages(locale) {\n  const normalized = isLocale(locale) ? locale : baseLocale;\n  if (localeCache.has(normalized)) return localeCache.get(normalized);\n  const loader = localeLoaders["../paraglide-generated/messages/" + normalized + ".js"];\n  if (!loader) return baseMessages;\n  const mod = await loader();\n  return cacheModule(normalized, mod);\n}\n\nconst getMessagesForLocale = (locale) => {\n  const normalized = isLocale(locale) ? locale : baseLocale;\n  const cached = localeCache.get(normalized);\n  if (cached) return cached;\n  void preloadLocaleMessages(normalized);\n  return baseMessages;\n};\n\n`;

const exports = keys
  .map((key) => {
    return `export const ${key} = (inputs = {}, options = {}) => {\n  const locale = options?.locale ?? getLocale();\n  return getMessagesForLocale(locale).${key}(inputs);\n};`;
  })
  .join("\n\n");

const mObject = `\n\nexport const m = {\n  ${keys.join(",\n  ")}\n};\n`;

const out = header + exports + mObject;
const outPath = path.join(frontendRoot, "src", "lib", "paraglide", "messages.js");

fs.mkdirSync(path.dirname(outPath), { recursive: true });
fs.writeFileSync(outPath, out + "\n");

console.log(`Generated ${keys.length} message exports to ${outPath}`);
