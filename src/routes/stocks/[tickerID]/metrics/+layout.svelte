<script lang="ts">
  import { stockTicker } from "$lib/store";
  import { page } from "$app/stores";

  export let data;

  let subsectionTitles = [];
  let sectionMap = {};
  let displaySubSection = "overview";

  // Helper functions (defined once, not recreated)
  function convertToTitleCase(str: string): string {
    return str
      ?.split("-")
      ?.map((word) => word.charAt(0).toUpperCase() + word.slice(1))
      ?.join(" ")
      ?.replace("Oem", "OEM");
  }

  function changeSubSection(state: string) {
    displaySubSection = state;
  }

  function getHref(section: string): string {
    const path =
      section === "overview" ? "/metrics" : `/metrics/${sectionMap[section]}`;
    return `/stocks/${$stockTicker}${path}`;
  }

  function getPrefixPriority(name: string): string {
    if (name.startsWith("Revenue")) return "1-Revenue";
    if (name.startsWith("Gross")) return "2-Gross";
    if (name.startsWith("Operating")) return "3-Operating";
    if (name.startsWith("Vehicles")) return "4-Vehicles";
    if (name.startsWith("Energy")) return "5-Energy";
    return "9-" + name.split(" ")[0];
  }

  function sortCategories(a: string, b: string): number {
    if (a === "Operating Metrics") return -1;
    if (b === "Operating Metrics") return 1;

    const aHasGeography = a.includes("Geography");
    const bHasGeography = b.includes("Geography");
    if (aHasGeography && !bHasGeography) return 1;
    if (!aHasGeography && bHasGeography) return -1;

    const prefixA = getPrefixPriority(a);
    const prefixB = getPrefixPriority(b);

    if (prefixA !== prefixB) {
      return prefixA.localeCompare(prefixB);
    }
    return a.localeCompare(b);
  }

  function createSlug(title: string): string {
    return title
      ?.toLowerCase()
      ?.replace(/&/g, "")
      ?.replace(/\s+/g, "-")
      ?.replace(/-{2,}/g, "-")
      ?.replace(/^-|-$/g, "")
      ?.trim();
  }

  // Track current path for active section
  $: if ($page?.url?.pathname && sectionMap) {
    const parts = $page.url.pathname.split("/");
    const foundSection = parts?.find(
      (part) => part && Object?.values(sectionMap)?.includes(part),
    );
    displaySubSection =
      Object?.keys(sectionMap)?.find(
        (key) => sectionMap[key] === foundSection,
      ) || "overview";
  }

  // Process metrics data - use TTM as default for navigation
  $: if ($stockTicker && data?.getData?.ttm) {
    const metricsData = data.getData.ttm;

    // Categorize metrics in single pass
    const tempCategorized = {};
    const operatingMetrics = [];

    for (const metric of metricsData) {
      const category = metric?.category || "Other";
      if (!tempCategorized[category]) {
        tempCategorized[category] = [];
      }
      tempCategorized[category].push(metric);
    }

    // Build final categories
    const finalCategories = [];
    for (const [category, metrics] of Object.entries(tempCategorized)) {
      if (metrics?.length === 1) {
        operatingMetrics.push(...metrics);
      } else {
        finalCategories.push(category);
      }
    }

    if (operatingMetrics.length > 0) {
      finalCategories.push("Operating Metrics");
    }

    // Sort categories and filter out Operating Metrics
    const sortedCategories = finalCategories
      ?.sort(sortCategories)
      ?.filter((cat) => cat !== "Operating Metrics");

    subsectionTitles = ["Overview", ...sortedCategories];

    // Create section map
    sectionMap = Object.fromEntries(
      subsectionTitles.map((title) => {
        const key = createSlug(title);
        return [key, key === "overview" ? "" : key];
      }),
    );
  }
</script>

<section class="w-full overflow-hidden h-full">
  <div class="m-auto h-full overflow-hidden">
    <main class="w-full">
      <div class="m-auto">
        {#if subsectionTitles.length > 0}
          <nav
            class="sm:ml-4 pt-1 text-sm sm:text-[1rem] whitespace-nowrap overflow-x-auto"
          >
            <ul class="flex flex-row items-center w-full">
              {#each subsectionTitles as title (title)}
                {@const sectionKey = createSlug(title)}
                <a
                  href={getHref(sectionKey)}
                  on:click={() => changeSubSection(sectionKey)}
                  class="p-2 px-5 cursor-pointer {displaySubSection ===
                  sectionKey
                    ? 'text-muted dark:text-white bg-[#EEEEEE] dark:bg-primary/90 font-semibold'
                    : 'text-gray-600 dark:text-gray-400 sm:hover:text-muted dark:sm:hover:text-white sm:hover:bg-[#EEEEEE] dark:sm:hover:bg-primary/90'}"
                >
                  {convertToTitleCase(title)}
                </a>
              {/each}
            </ul>
          </nav>
        {/if}
      </div>
    </main>

    <slot />
  </div>
</section>

<style>
  .scrollbar {
    display: grid;
    grid-gap: 18px;
    grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
    grid-auto-flow: column;
    overflow-x: auto;
    scrollbar-width: thin;
    scrollbar-color: transparent transparent;
  }

  .scrollbar::-webkit-scrollbar {
    width: 0;
    height: 0;
  }

  .scrollbar::-webkit-scrollbar-thumb {
    background: transparent;
  }
</style>
